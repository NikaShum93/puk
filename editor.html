<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sheep Run ‚Äî –†–µ–¥–∞–∫—Ç–æ—Ä</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    html,body{height:100%;}
    :root{
      --primary:#00E5FF;
      --accent:#FF4081;
      --glass:rgba(255,255,255,0.95);
      --bg1:#2a003b;
      --bg2:#000;
      --stroke:rgba(0,0,0,.10);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Montserrat',sans-serif;
      background: radial-gradient(circle at center, var(--bg1) 0%, var(--bg2) 100%);
      padding:24px 14px;
      color:#222;
      overflow:auto;
    }
    .bg-float{
      position:fixed; font-size:46px; opacity:.25; z-index:-1;
      animation: floatSpace 22s infinite linear;
      pointer-events:none;
    }
    @keyframes floatSpace{
      0%{transform:translateY(110vh) rotate(0deg)}
      100%{transform:translateY(-10vh) rotate(360deg)}
    }

    /* 16:9 stage */
    .wrap{
      width:min(1280px, calc(100vw - 24px));
      aspect-ratio:16 / 9;
      height:auto;
      max-height:min(92vh, 720px);
      margin:0 auto;
      background:var(--glass);
      border-radius:18px;
      border:2px solid rgba(255,255,255,0.1);
      box-shadow:0 0 18px var(--primary), 0 0 60px rgba(0,229,255,.18);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    /* fixed top bar inside editor (never scrolls away) */
    .top{
      padding:18px 18px 10px 18px;
      background:linear-gradient(to bottom, rgba(255,255,255,.95), rgba(255,255,255,.88));
      border-bottom:1px solid rgba(0,0,0,.06);
      flex:none;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width:280px;
    }
    .logoBox{
      width:44px; height:44px;
      border-radius:14px;
      background:rgba(0,229,255,.12);
      border:1px solid rgba(0,229,255,.25);
      display:flex; align-items:center; justify-content:center;
      font-size:26px;
      flex:none;
    }
    .brandTitle{
      display:flex; flex-direction:column;
      gap:2px;
    }
    .brandTitle h1{
      margin:0;
      font-family:'Fredoka One',cursive;
      font-size:38px;
      line-height:1;
      text-shadow:2px 2px 0 var(--primary);
    }
    .brandTitle .mini{
      font-weight:900;
      color:var(--accent);
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .authorLine{
      font-size:12px;
      font-weight:900;
      opacity:.75;
      margin-top:2px;
    }
    .langRow{
      display:flex; align-items:center; gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    label{font-weight:800; font-size:12px; text-transform:uppercase; letter-spacing:.08em; color:#444}
    select,input[type=text],textarea{
      width:100%;
      padding:10px;
      border-radius:12px;
      border:2px solid #ddd;
      font-family:'Montserrat',sans-serif;
      outline:none;
      transition:.15s;
      background:white;
      font-size:14px;
    }
    textarea{
      min-height:120px;
      resize:vertical;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    select:focus,input:focus,textarea:focus{
      border-color:var(--primary);
      box-shadow:0 0 10px rgba(0,229,255,.25);
    }

    /* Tabs row (can wrap to two lines; but must stay fixed) */
    .tabbar{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:flex-end;
      margin-top:10px;
    }
    .tab{
      appearance:none;
      border:none;
      background:rgba(255,255,255,.55);
      border:1px solid var(--stroke);
      border-bottom:none;
      padding:10px 12px;
      border-top-left-radius:14px;
      border-top-right-radius:14px;
      font-weight:900;
      letter-spacing:.04em;
      text-transform:uppercase;
      font-size:12px;
      color:#222;
      cursor:pointer;
      transition:.12s;
    }
    .tab:hover{ transform:translateY(-1px); }

    .tabPanel{display:none}
    .tabPanel.active{display:block}
    .tab.active{
      background:rgba(255,255,255,.95);
      box-shadow:0 -6px 18px rgba(0,229,255,.12);
      border-color:rgba(0,229,255,.35);
      color:#111;
    }

    /* main area under fixed top bar */
    .main{
      flex:1;
      min-height:0;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:14px;
      padding:14px 18px 18px 18px;
    }
    @media (max-width: 980px){
      .wrap{max-height:none;}
      .main{ grid-template-columns:1fr; }
    }

    /* left: scrollable panel */
    .left{
      min-height:0;
      overflow:auto;
      padding-right:6px;
    }
    .left::-webkit-scrollbar{width:10px}
    .left::-webkit-scrollbar-thumb{background:rgba(0,0,0,.12); border-radius:999px}
    .left::-webkit-scrollbar-track{background:transparent}

    /* right: toolbar fixed, preview flex */
    .right{
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .btn{
      border:none;
      border-radius:14px;
      padding:12px 14px;
      cursor:pointer;
      background:#222;
      color:#fff;
      font-weight:900;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
    .btn.primary{
      background:linear-gradient(45deg, var(--primary), #00B8D4);
      box-shadow:0 5px 15px rgba(0,229,255,.25);
    }
    .btn.ghost{
      background:#fff;
      color:#111;
      border:2px solid rgba(0,0,0,.12);
    }
    .status{
      margin-left:auto;
      font-weight:900;
      color:#333;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.7);
      border:1px solid rgba(0,0,0,.08);
      min-width:140px;
      text-align:center;
    }

    /* preview */
    .previewOuter{
      flex:1;
      min-height:0;
      background:rgba(0,0,0,.06);
      border:1px dashed rgba(0,0,0,.2);
      border-radius:14px;
      padding:10px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .previewStage{
      height:100%;
      width:auto;
      max-width:100%;
      max-height:100%;
      aspect-ratio:16/9;
      border-radius:12px;
      overflow:hidden;
      background:transparent;
      margin:auto;
      position:relative;
    }
    .previewFrame{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      border:0;
      background:transparent;
      display:block;
    }

    /* cards */
    .card{
      background:rgba(255,255,255,.6);
      border:1px solid var(--stroke);
      border-radius:14px;
      padding:14px;
      margin-bottom:12px;
    }
    .card h2{
      margin:0 0 10px;
      font-size:15px;
      display:flex; align-items:center; gap:10px;
      border-bottom:2px solid var(--primary);
      padding-bottom:8px;
    }
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .grid3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
    .checks{display:flex; flex-wrap:wrap; gap:14px; margin-top:10px}
    .chk{
      display:flex; align-items:center; gap:8px;
      font-size:12px; font-weight:900; letter-spacing:.06em; text-transform:uppercase;
      color:#333;
    }
    .chk input{ width:18px; height:18px; accent-color: var(--accent); }
    .help{ font-size:12px; color:#555; opacity:.92; margin-top:6px; line-height:1.35; }
    .qStack{ display:flex; flex-direction:column; gap:12px; }
    .rangeRow{ display:flex; align-items:center; gap:12px; }
    .rangeVal{ font-weight:900; min-width:54px; text-align:right; }
    .emojiBar{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .emojiBtn{
      width:36px; height:36px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.15);
      background:white;
      cursor:pointer;
      font-size:20px;
      display:flex; align-items:center; justify-content:center;
      transition:.08s;
    }
    .emojiBtn:hover{ transform:translateY(-1px) }

    /* toast */
    .toast{
      position:fixed;
      left:50%; bottom:22px;
      transform:translateX(-50%);
      background:rgba(0,0,0,.85);
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-weight:800;
      letter-spacing:.03em;
      opacity:0;
      pointer-events:none;
      transition:.2s;
      z-index:9999;
    }
    .toast.show{ opacity:1; }
    footer{
      text-align:center;
      padding:10px 18px 14px 18px;
      font-size:12px;
      font-weight:900;
      opacity:.7;
      border-top:1px solid rgba(0,0,0,.06);
      flex:none;
      background:rgba(255,255,255,.85);
    }

    /* soft "no devtools" overlay */
    .devtools-overlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:24px;
      background:rgba(0,0,0,.86);
      z-index:100000;
    }
    .devtools-card{
      width:min(720px, 96vw);
      background:#111;
      border:2px solid rgba(255,255,255,.15);
      border-radius:18px;
      box-shadow:0 0 24px rgba(0,229,255,.25);
      padding:18px 18px 16px;
      color:#fff;
      text-align:center;
      font-family:'Montserrat',sans-serif;
    }
    .devtools-card h3{
      margin:0 0 8px;
      font-family:'Fredoka One',cursive;
      font-weight:400;
      letter-spacing:.04em;
      font-size:28px;
    }
    .devtools-card p{
      margin:0;
      opacity:.9;
      line-height:1.4;
      font-weight:700;
    }

    /* ===== Password gate (simple) ===== */
    body.locked { overflow:hidden; }
    body.locked .wrap { display:none; }

    .pass-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.86);
      display:none;
      align-items:center; justify-content:center;
      z-index:110000;
      padding:24px;
    }
    body.locked .pass-overlay{ display:flex; }

    .pass-card{
      width:min(520px, 96vw);
      background:rgba(255,255,255,.96);
      border-radius:18px;
      border:2px solid rgba(0,229,255,.25);
      box-shadow:0 0 24px rgba(0,229,255,.22);
      padding:18px;
      text-align:center;
    }
    .pass-card h3{
      margin:0 0 8px;
      font-family:'Fredoka One',cursive;
      font-size:28px;
    }
    .pass-card p{
      margin:0 0 12px;
      font-weight:800;
      opacity:.85;
    }
    .pass-row{
      display:flex; gap:10px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
    }
    .pass-input{
      width:min(320px, 90vw);
      padding:12px 14px;
      border-radius:14px;
      border:2px solid #ddd;
      outline:none;
      font-weight:900;
      letter-spacing:.06em;
      text-align:center;
      font-family:'Montserrat',sans-serif;
    }
    .pass-input:focus{
      border-color:var(--primary);
      box-shadow:0 0 10px rgba(0,229,255,.25);
    }
    .pass-btn{
      border:none;
      border-radius:14px;
      padding:12px 14px;
      cursor:pointer;
      background:linear-gradient(45deg, var(--primary), #00B8D4);
      color:white;
      font-weight:900;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
    .pass-err{
      margin-top:10px;
      color:#c62828;
      font-weight:900;
      display:none;
    }
  </style>
</head>
<body>

  <!-- ===== Password gate ===== -->
  <div class="pass-overlay" id="passOverlay" aria-hidden="true">
    <div class="pass-card">
      <h3>üîí –î–æ—Å—Ç—É–ø –∫ —Ä–µ–¥–∞–∫—Ç–æ—Ä—É</h3>
      <p>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</p>

      <div class="pass-row">
        <input class="pass-input" id="passInput" type="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="off">
        <button class="pass-btn" id="passBtn" type="button">–í–æ–π—Ç–∏</button>
      </div>

      <div class="pass-err" id="passErr">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div>
    </div>
  </div>

  <div class="bg-float" style="left:10%; animation-duration: 26s;">üêë</div>
  <div class="bg-float" style="left:80%; animation-duration: 30s; animation-delay:-7s;">üöÄ</div>
  <div class="bg-float" style="left:30%; animation-duration: 22s; animation-delay:-12s;">ü™ê</div>
  <div class="bg-float" style="left:60%; animation-duration: 28s; animation-delay:-3s;">üëæ</div>

  <div class="wrap">
    <div class="top">
      <header>
        <div class="brand">
          <div class="logoBox" aria-hidden="true">üêë</div>
          <div class="brandTitle">
            <h1 id="uiHeaderTitle">SHEEP RUN</h1>
            <div class="mini" id="uiHeaderMini">–†–µ–¥–∞–∫—Ç–æ—Ä –∏–≥—Ä—ã</div>
            <div class="authorLine">–ù–∏–∫–∞ –®—É–º @teachy_witchy</div>
          </div>
        </div>

        <div class="langRow">
          <label id="lblLang">–Ø–∑—ã–∫</label>
          <select id="uiLang" style="min-width:160px">
            <option value="ru" selected>–†—É—Å—Å–∫–∏–π</option>
            <option value="en">English</option>
            <option value="fr">Fran√ßais</option>
            <option value="de">Deutsch</option>
            <option value="es">Espa√±ol</option>
            <option value="it">Italiano</option>
            <option value="zh">‰∏≠Êñá</option>
            <option value="ja">Êó•Êú¨Ë™û</option>
          </select>
        </div>
      </header>

      <div class="tabbar" id="tabs">
        <button type="button" class="tab active" data-tab="settings" id="tab_settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        <button type="button" class="tab" data-tab="tasks" id="tab_tasks">–ó–∞–¥–∞–Ω–∏—è</button>
        <button type="button" class="tab" data-tab="pics" id="tab_pics">–ö–∞—Ä—Ç–∏–Ω–∫–∏</button>
        <button type="button" class="tab" data-tab="sounds" id="tab_sounds">–ó–≤—É–∫–∏</button>
      </div>
    </div>

    <div class="main">
      <div class="left">
        <!-- PANELS -->
        <div class="tabPanel active" data-panel="settings" id="panel_settings">
          <div class="card">
            <h2>‚öôÔ∏è <span id="tGame">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></h2>
            <div class="grid2">
              <div>
                <label id="lblMode">–†–µ–∂–∏–º</label>
                <select id="gameMode">
                  <option value="choice" selected>–ö–Ω–æ–ø–∫–∏ (A/B)</option>
                  <option value="input">–í–ø–∏—à–∏ –æ—Ç–≤–µ—Ç</option>
                </select>
              </div>
              <div>
                <label id="lblGameLang">–Ø–∑—ã–∫ –∏–≥—Ä—ã</label>
                <select id="gameLang">
                  <option value="ru" selected>–†—É—Å—Å–∫–∏–π</option>
                  <option value="en">English</option>
                  <option value="fr">Fran√ßais</option>
                  <option value="de">Deutsch</option>
                  <option value="es">Espa√±ol</option>
                  <option value="it">Italiano</option>
                  <option value="zh">‰∏≠Êñá</option>
                  <option value="ja">Êó•Êú¨Ë™û</option>
                </select>
              </div>
              <div>
                <label id="lblWin">–°–∫–æ–ª—å–∫–æ –∑–∞–¥–∞–Ω–∏–π –¥–æ –ø–æ–±–µ–¥—ã</label>
                <input id="winQuestions" type="text" value="10" />
              </div>
            </div>

            <!-- ===== NEW: auto speed (base = EASY) ===== -->
            <div style="margin-top:10px">
              <label id="lblSpawnBase">–ü–∞—É–∑–∞ –º–µ–∂–¥—É –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è–º–∏ (EASY)</label>
              <div class="rangeRow">
                <input id="spawnBase" type="range" min="3" max="14" step="0.5" value="8.5" style="width:100%">
                <div class="rangeVal"><span id="spawnBaseVal">8.5</span>s</div>
              </div>
              <div class="help" id="hSpawnAuto">
                MEDIUM: <b><span id="spawnMedVal">7.5</span>s</b> ‚Ä¢ HARD: <b><span id="spawnHardVal">6.5</span>s</b>
              </div>
            </div>

            <div style="margin-top:10px">
              <label id="lblMoveBase">–°–∫–æ—Ä–æ—Å—Ç—å –º–∏—Ä–∞ (EASY)</label>
              <div class="rangeRow">
                <input id="moveBase" type="range" min="2.5" max="10" step="0.1" value="6.0" style="width:100%">
                <div class="rangeVal"><span id="moveBaseVal">6.0</span></div>
              </div>
              <div class="help" id="hMoveAuto">
                MEDIUM: <b><span id="moveMedVal">5.3</span></b> ‚Ä¢ HARD: <b><span id="moveHardVal">4.6</span></b>
              </div>
            </div>

            <div class="checks">
              <label class="chk"><input type="checkbox" id="mathMode"><span id="lblMath">MathJax</span></label>
              <label class="chk"><input type="checkbox" id="transparentBg"><span id="lblTransparent">–ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω</span></label>
            </div>
          </div>

          <div class="card">
            <h2>üß© <span id="tUi">–¢–µ–∫—Å—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</span></h2>
            <div class="grid2">
              <div><label id="lTitle">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="ui_title" type="text" value="SHEEP RUN"></div>
              <div><label id="lStart">–ö–Ω–æ–ø–∫–∞ –°—Ç–∞—Ä—Ç</label><input id="ui_start" type="text" value="PLAY"></div>
              <div><label id="lAgain">–ö–Ω–æ–ø–∫–∞ –ü–æ–≤—Ç–æ—Ä</label><input id="ui_again" type="text" value="AGAIN"></div>
              <div><label id="lOver">–¢–µ–∫—Å—Ç –ø—Ä–∏ –ø—Ä–æ–∏–≥—Ä—ã—à–µ</label><input id="ui_over" type="text" value="GAME OVER"></div>
              <div style="grid-column:1 / -1"><label id="lScore">–ü–æ–¥–ø–∏—Å—å —Å—á—ë—Ç–∞</label><input id="ui_score" type="text" value="Score: "></div>
            </div>
            <div class="help" id="hUiHelp">–Ø–∑—ã–∫ –º–æ–∂–µ—Ç –ø–æ–¥—Å—Ç–∞–≤–ª—è—Ç—å –±–∞–∑–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å–∏. –ï—Å–ª–∏ –≤–ø–∏—Å–∞–ª–∏ —Å–≤–æ—ë ‚Äî –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤–∞—à–µ.</div>
          </div>
        </div>

        <div class="tabPanel" data-panel="tasks" id="panel_tasks">
          <div class="card">
            <h2>üìù <span id="tQuestions">–ó–∞–¥–∞–Ω–∏—è</span></h2>
            <div class="help" id="hQuestions">
              –í—Å—Ç–∞–≤–ª—è–π –∏–∑ Excel: <b>–∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ = –æ–¥–Ω–æ –∑–∞–¥–∞–Ω–∏–µ</b>.<br>
              –í ‚Äú–í–µ—Ä–Ω–æ‚Äù –º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ <b>|</b> (–Ω–∞–ø—Ä–∏–º–µ—Ä: meow|mew).<br>
              –í —Ä–µ–∂–∏–º–µ ‚Äú–í–ø–∏—à–∏ –æ—Ç–≤–µ—Ç‚Äù –∫–æ–ª–æ–Ω–∫–∞ ‚Äú–ù–µ–≤–µ—Ä–Ω–æ‚Äù –Ω–µ –Ω—É–∂–Ω–∞.
            </div>

            <div class="checks" style="margin-top:10px">
              <label class="chk"><input type="checkbox" id="randomQuestions" checked><span id="lblRandom">–†–∞–Ω–¥–æ–º –≤–æ–ø—Ä–æ—Å–æ–≤</span></label>
            </div>

            <div style="margin-top:10px">
              <label id="lFont">–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –∑–∞–¥–∞–Ω–∏—è</label>
              <div class="rangeRow">
                <input id="fontSize" type="range" min="5" max="12" step="0.5" value="8" style="width:100%">
                <div class="rangeVal"><span id="fontSizeVal">8</span>vmin</div>
              </div>
              <div class="help" id="hFont">–ú–µ–Ω—è–µ—Ç —Ä–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –≤ –æ–±–ª–∞—á–∫–µ –∑–∞–¥–∞–Ω–∏—è.</div>
            </div>

            <div class="qStack" style="margin-top:12px">
              <div>
                <label id="lQ">–í–æ–ø—Ä–æ—Å</label>
                <textarea id="q_col" placeholder="Dog ___ fast.&#10;Cat ___ milk."></textarea>
              </div>
              <div>
                <label id="lC">–í–µ—Ä–Ω–æ</label>
                <textarea id="c_col" placeholder="runs&#10;drinks"></textarea>
              </div>
              <div>
                <label id="lW">–ù–µ–≤–µ—Ä–Ω–æ</label>
                <textarea id="w_col" placeholder="run&#10;drink"></textarea>
              </div>
            </div>
          </div>
        </div>

        <div class="tabPanel" data-panel="pics" id="panel_pics">
          <div class="card">
            <h2>üé® <span id="tAssets">–ü–µ—Ä—Å–æ–Ω–∞–∂ –∏ –ø—Ä–µ–¥–º–µ—Ç—ã</span></h2>
            <div class="help" id="hAssets">–ú–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å —ç–º–æ–¥–∑–∏ (üêë) –∏–ª–∏ –≤—Å—Ç–∞–≤–ª—è—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É/–≥–∏—Ñ (https://...). –°–ø–∏—Å–∫–∏ ‚Äî —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –∏–ª–∏ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏.</div>

            <div style="margin-top:10px">
              <label id="lHero">–ü–µ—Ä—Å–æ–Ω–∞–∂</label>
              <input id="hero" type="text" value="üêë">
              <div class="emojiBar" id="heroEmojiBar"></div>

              <div class="checks" style="margin-top:10px">
                <label class="chk"><input type="checkbox" id="mirrorHero"><span id="lblMirror">–û—Ç—Ä–∞–∑–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</span></label>
                <label class="chk"><input type="checkbox" id="heroBobbing" checked><span id="lblBobbing">–ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</span></label>
              </div>
            </div>

            <div class="grid3" style="margin-top:12px">
              <div>
                <label id="lGround">–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è (–∑–µ–º–ª—è)</label>
                <textarea id="obs_ground">üå≤,ü™®,ü™µ,üåµ</textarea>
              </div>
              <div>
                <label id="lGood">–ü–æ–ª–µ–∑–Ω—ã–µ (–ª–µ—Ç—è—Ç)</label>
                <textarea id="obs_good">üåæ,üåΩ,üçÄ,üçé</textarea>
              </div>
              <div>
                <label id="lBad">–û–ø–∞—Å–Ω—ã–µ (–ª–µ—Ç—è—Ç)</label>
                <textarea id="obs_bad">ü¶Ö,üß±,üöÅ,‚õàÔ∏è</textarea>
              </div>
            </div>
          </div>
        </div>

        <div class="tabPanel" data-panel="sounds" id="panel_sounds">
          <div class="card">
            <h2>üîä <span id="tAudio">–ó–≤—É–∫–∏</span></h2>
            <div class="help" id="hAudio">–ú—É–∑—ã–∫–∞ –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã ‚Äî –ø–æ —Å—Å—ã–ª–∫–∞–º (mp3/ogg). –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∞–∑–æ–≤—ã–µ.</div>
            <div class="grid2" style="margin-top:10px">
              <div><label>Music</label><input id="aud_mus" type="text" value="https://raw.githubusercontent.com/kgbgamelab/audioplayer/main/Baa%20Dash.mp3"></div>
              <div><label>Ding</label><input id="aud_ding" type="text" value="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></div>
              <div><label>Buzz</label><input id="aud_buzz" type="text" value="https://assets.mixkit.co/active_storage/sfx/257/257-preview.mp3"></div>
              <div><label>Coin</label><input id="aud_coin" type="text" value="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></div>
              <div><label>Crash</label><input id="aud_crash" type="text" value="https://assets.mixkit.co/active_storage/sfx/2042/2042-preview.mp3"></div>
              <div><label>Win</label><input id="aud_win" type="text" value="https://assets.mixkit.co/active_storage/sfx/2018/2018-preview.mp3"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="right">
        <div class="toolbar">
          <button class="btn ghost" id="btnPreview">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é</button>
          <button class="btn primary" id="btnPublish">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä—É</button>
          <button class="btn ghost" id="btnGet">–ü–æ–ª—É—á–∏—Ç—å –∏–≥—Ä—É</button>
          <div class="status" id="statusPill">–ì–æ—Ç–æ–≤–æ</div>
        </div>

        <div class="previewOuter">
          <div class="previewStage">
            <iframe id="preview" class="previewFrame"
              allow="autoplay; fullscreen"
              sandbox="allow-scripts allow-same-origin allow-forms"
            ></iframe>
          </div>
        </div>
      </div>
    </div>

    <footer>¬© 2026 –ù–∏–∫–∞ –®—É–º ‚Ä¢ @teachy_witchy</footer>

    <div class="devtools-overlay" id="devtoolsOverlay" aria-hidden="true">
      <div class="devtools-card">
        <h3>üßô‚Äç‚ôÄÔ∏è –†–µ–∂–∏–º —É—á–∏—Ç–µ–ª—è</h3>
        <p>–≠—Ç–æ—Ç —Ä–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä.<br>–ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∏ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ. –ò–≥—Ä–∞ –∑–∞—â–∏—â–µ–Ω–∞ –∞–≤—Ç–æ—Ä—Å–∫–∏–º –ø—Ä–∞–≤–æ–º.</p>
      </div>
    </div>

  </div>

  <div class="toast" id="toast">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!</div>

<script>
  // ===== Password gate (simple, editable) =====
  const ACCESS_PASSWORD = "WITCHY-2026"; // <-- –ø–æ–º–µ–Ω—è–π –∫–∞–∫ —Ö–æ—á–µ—à—å
  const ACCESS_HOURS = 12; // –º–æ–∂–Ω–æ 0 (—Ç–æ–≥–¥–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ–∫—É—â—É—é –≤–∫–ª–∞–¥–∫—É)

  (function passwordGate(){
    const now = Date.now();
    const key = "sheep_editor_access_until";
    const until = Number(localStorage.getItem(key) || 0);

    function lock(){
      document.body.classList.add("locked");
      setTimeout(()=>{ const i=document.getElementById('passInput'); if(i) i.focus(); }, 50);
    }
    function unlock(){
      document.body.classList.remove("locked");
    }

    if(until && until > now) unlock();
    else lock();

    function tryLogin(){
      const inp = document.getElementById("passInput");
      const err = document.getElementById("passErr");
      const val = (inp?.value || "").trim();

      if(val === ACCESS_PASSWORD){
        if(ACCESS_HOURS > 0){
          localStorage.setItem(key, String(Date.now() + ACCESS_HOURS*3600*1000));
        } else {
          localStorage.removeItem(key);
        }
        if(err) err.style.display = "none";
        if(inp) inp.value = "";
        unlock();
      } else {
        if(err) err.style.display = "block";
        if(inp) inp.select();
      }
    }

    document.addEventListener("click", (e)=>{
      if(e.target && e.target.id === "passBtn") tryLogin();
    });

    document.addEventListener("keydown", (e)=>{
      if(document.body.classList.contains("locked") && e.key === "Enter") {
        e.preventDefault(); tryLogin();
      }
    });
  })();

  // ====== CONFIG ======
  // –í–ê–ñ–ù–û: –µ—Å–ª–∏ —Ç—ã –±—É–¥–µ—à—å —Ö–æ—Å—Ç–∏—Ç—å main_autospeed.html –Ω–∞ GitHub Pages,
  // –ø—Ä–æ—Å—Ç–æ –ø–æ–º–µ–Ω—è–π BASE_MAIN –Ω–∞ –Ω–æ–≤—ã–π URL.
  const BASE_MAIN   = "https://nikashum93.github.io/puk/main.html";
  const ENDPOINT    = "https://server-kjnn.onrender.com/publish";
  const PUBLISH_KEY = "nika_read_pub_2025";

  // ====== Difficulty multipliers (auto) ======
  const DIFF_MED_MULT  = 0.88;
  const DIFF_HARD_MULT = 0.76;

  // ====== i18n ======
  const I18N = {
    ru: {
      mini:"–†–µ–¥–∞–∫—Ç–æ—Ä –∏–≥—Ä—ã",
      lang:"–Ø–∑—ã–∫", mode:"–†–µ–∂–∏–º", win:"–°–∫–æ–ª—å–∫–æ –∑–∞–¥–∞–Ω–∏–π –¥–æ –ø–æ–±–µ–¥—ã",
      math:"MathJax", transparent:"–ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω", mirror:"–û—Ç—Ä–∞–∑–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞", random:"–†–∞–Ω–¥–æ–º –≤–æ–ø—Ä–æ—Å–æ–≤",
      tGame:"–ù–∞—Å—Ç—Ä–æ–π–∫–∏", tUi:"–¢–µ–∫—Å—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞", tAssets:"–ü–µ—Ä—Å–æ–Ω–∞–∂ –∏ –ø—Ä–µ–¥–º–µ—Ç—ã", tAudio:"–ó–≤—É–∫–∏", tQ:"–ó–∞–¥–∞–Ω–∏—è",
      title:"–ù–∞–∑–≤–∞–Ω–∏–µ", start:"–ö–Ω–æ–ø–∫–∞ –°—Ç–∞—Ä—Ç", again:"–ö–Ω–æ–ø–∫–∞ –ü–æ–≤—Ç–æ—Ä", over:"–¢–µ–∫—Å—Ç –ø—Ä–∏ –ø—Ä–æ–∏–≥—Ä—ã—à–µ", score:"–ü–æ–¥–ø–∏—Å—å —Å—á—ë—Ç–∞",
      q:"–í–æ–ø—Ä–æ—Å", c:"–í–µ—Ä–Ω–æ", w:"–ù–µ–≤–µ—Ä–Ω–æ",
      spawnBase:"–ü–∞—É–∑–∞ –º–µ–∂–¥—É –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è–º–∏ (EASY)",
      moveBase:"–°–∫–æ—Ä–æ—Å—Ç—å –º–∏—Ä–∞ (EASY)",
      assetsHelp:"–ú–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å —ç–º–æ–¥–∑–∏ (üêë) –∏–ª–∏ –≤—Å—Ç–∞–≤–ª—è—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É/–≥–∏—Ñ (https://...). –°–ø–∏—Å–∫–∏ ‚Äî —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –∏–ª–∏ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏.",
      audioHelp:"–ú—É–∑—ã–∫–∞ –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã ‚Äî –ø–æ —Å—Å—ã–ª–∫–∞–º (mp3/ogg). –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∞–∑–æ–≤—ã–µ.",
      qHelp:"–í—Å—Ç–∞–≤–ª—è–π –∏–∑ Excel: –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ = –æ–¥–Ω–æ –∑–∞–¥–∞–Ω–∏–µ. –í ‚Äú–í–µ—Ä–Ω–æ‚Äù –º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ |. –í —Ä–µ–∂–∏–º–µ ‚Äú–í–ø–∏—à–∏ –æ—Ç–≤–µ—Ç‚Äù –∫–æ–ª–æ–Ω–∫–∞ ‚Äú–ù–µ–≤–µ—Ä–Ω–æ‚Äù –Ω–µ –Ω—É–∂–Ω–∞.",
      btnPrev:"–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é", btnPub:"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä—É", btnGet:"–ü–æ–ª—É—á–∏—Ç—å –∏–≥—Ä—É",
      stReady:"–ì–æ—Ç–æ–≤–æ", stPub:"–°–æ–∑–¥–∞—é‚Ä¶", stErr:"–û—à–∏–±–∫–∞", stWait:"–ì–æ—Ç–æ–≤–æ ‚úÖ",
      uiHelp:"–Ø–∑—ã–∫ –º–æ–∂–µ—Ç –ø–æ–¥—Å—Ç–∞–≤–ª—è—Ç—å –±–∞–∑–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å–∏. –ï—Å–ª–∏ –≤–ø–∏—Å–∞–ª–∏ —Å–≤–æ—ë ‚Äî –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤–∞—à–µ."
    },
    en: {
      mini:"Game editor",
      lang:"Language", mode:"Mode", win:"Tasks to win",
      math:"MathJax", transparent:"Transparent BG", mirror:"Mirror hero", random:"Random order",
      tGame:"Settings", tUi:"UI texts", tAssets:"Hero & items", tAudio:"Audio", tQ:"Tasks",
      title:"Title", start:"Start button", again:"Again button", over:"Lose text", score:"Score label",
      q:"Question", c:"Correct", w:"Wrong",
      spawnBase:"Obstacle interval (EASY)",
      moveBase:"World speed (EASY)",
      assetsHelp:"Use emoji (üêë) or an image/gif URL (https://...). Lists: commas or new lines.",
      audioHelp:"Music & SFX via URLs (mp3/ogg). You can leave empty to use basic sounds.",
      qHelp:"Paste from Excel: one line = one task. ‚ÄúCorrect‚Äù can include multiple options via |. In input mode, ‚ÄúWrong‚Äù is not required.",
      btnPrev:"Refresh preview", btnPub:"Generate game", btnGet:"Get game",
      stReady:"Ready", stPub:"Generating‚Ä¶", stErr:"Error", stWait:"Done ‚úÖ",
      uiHelp:"Language can auto-fill defaults. If you typed your own text, it stays."
    }
  };

  const $ = (id)=>document.getElementById(id);

  function toast(msg){
    const t = $('toast');
    if(!t) return;
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 1400);
  }

  function applyLang(lang){
    const t = I18N[lang] || I18N.ru;
    $('uiHeaderMini').textContent = t.mini;
    $('lblLang').textContent = t.lang;

    $('tGame').textContent = t.tGame;
    $('lblMode').textContent = t.mode;
    $('lblWin').textContent = t.win;
    $('lblMath').textContent = t.math;
    $('lblTransparent').textContent = t.transparent;

    if($('lblSpawnBase')) $('lblSpawnBase').textContent = t.spawnBase;
    if($('lblMoveBase')) $('lblMoveBase').textContent = t.moveBase;

    $('tUi').textContent = t.tUi;
    $('lTitle').textContent = t.title;
    $('lStart').textContent = t.start;
    $('lAgain').textContent = t.again;
    $('lOver').textContent = t.over;
    $('lScore').textContent = t.score;
    $('hUiHelp').textContent = t.uiHelp;

    $('tAssets').textContent = t.tAssets;
    $('hAssets').textContent = t.assetsHelp;
    $('lHero').textContent = (lang === 'ru') ? '–ü–µ—Ä—Å–æ–Ω–∞–∂' : 'Hero';
    $('lblMirror').textContent = t.mirror;
    $('lGround').textContent = (lang === 'ru') ? '–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è (–∑–µ–º–ª—è)' : 'Ground obstacles';
    $('lGood').textContent   = (lang === 'ru') ? '–ü–æ–ª–µ–∑–Ω—ã–µ (–ª–µ—Ç—è—Ç)' : 'Good (air)';
    $('lBad').textContent    = (lang === 'ru') ? '–û–ø–∞—Å–Ω—ã–µ (–ª–µ—Ç—è—Ç)' : 'Bad (air)';

    $('tAudio').textContent = t.tAudio;
    $('hAudio').textContent = t.audioHelp;

    $('tQuestions').textContent = t.tQ;
    $('hQuestions').innerHTML = (t.qHelp || '').replaceAll('|','<b>|</b>');
    $('lblRandom').textContent = t.random;
    $('lFont').textContent = (lang === 'ru') ? '–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –∑–∞–¥–∞–Ω–∏—è' : 'Task text size';
    $('hFont').textContent = (lang === 'ru') ? '–ú–µ–Ω—è–µ—Ç —Ä–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –≤ –æ–±–ª–∞—á–∫–µ –∑–∞–¥–∞–Ω–∏—è.' : 'Changes task bubble text size.';
    $('lQ').textContent = t.q;
    $('lC').textContent = t.c;
    $('lW').textContent = t.w;

    $('btnPreview').textContent = t.btnPrev;
    $('btnPublish').textContent = t.btnPub;
    $('btnGet').textContent = t.btnGet;
    $('statusPill').textContent = t.stReady;
  }

  function parseList(val){
    return String(val).split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
  }
  function parseLines(val){
    return String(val).split('\n').map(s=>s.replace(/\r/g,''));
  }

  function makeIdFromTitle(cfg){
    const raw = (cfg.ui?.title || 'sheep-run').toLowerCase();
    const slug = raw
      .replace(/[^a-z0-9–∞-—è—ë\s_-]/gi,'')
      .trim()
      .replace(/[\s]+/g,'-')
      .replace(/-+/g,'-')
      .slice(0,40) || 'sheep-run';
    const d = new Date();
    const pad = (n)=>String(n).padStart(2,'0');
    const stamp = `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
    return `${slug}-${stamp}`;
  }

  function collectConfig(){
    const editorLang = $('uiLang').value;
    const lang = $('gameLang') ? $('gameLang').value : editorLang;
    const mode = $('gameMode').value;
    const math = $('mathMode').checked;
    const transparentBg = $('transparentBg').checked;
    const mirrorHero = $('mirrorHero').checked;
    const heroBobbing = $('heroBobbing') ? $('heroBobbing').checked : true;
    const randomQuestions = $('randomQuestions').checked;

    const ui = {
      title: $('ui_title').value || 'SHEEP RUN',
      start: $('ui_start').value || (lang === 'ru' ? '–ò–ì–†–ê–¢–¨' : 'PLAY'),
      again: $('ui_again').value || (lang === 'ru' ? '–ï–©–Å –†–ê–ó' : 'AGAIN'),
      gameover: $('ui_over').value || (lang === 'ru' ? '–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê' : 'GAME OVER'),
      scoreLabel: $('ui_score').value || (lang === 'ru' ? '–°—á—ë—Ç: ' : 'Score: '),
      fontSize: parseFloat(($('fontSize')?.value || '8'))
    };

    const winQuestions = parseInt(($('winQuestions').value || '10'), 10);

    // ===== NEW: base values (EASY) =====
    const spawnBaseSec = parseFloat(($('spawnBase')?.value || '8.5'));  // seconds
    const moveBase     = parseFloat(($('moveBase')?.value || '6.0'));   // speed factor

    const gameplay = {
      winQuestions: Number.isFinite(winQuestions) ? winQuestions : 10,

      // base = EASY
      diffBaseSpawnMs: Math.round((Number.isFinite(spawnBaseSec) ? spawnBaseSec : 8.5) * 1000),
      diffBaseMoveSpeed: Number.isFinite(moveBase) ? moveBase : 6.0,

      // multipliers for auto-calc
      diffMedMult: DIFF_MED_MULT,
      diffHardMult: DIFF_HARD_MULT
    };

    const assets = {
      hero: $('hero').value || 'üêë',
      mirrorHero,
      heroBobbing,
      obstacles: {
        ground: parseList($('obs_ground').value),
        good:   parseList($('obs_good').value),
        bad:    parseList($('obs_bad').value)
      }
    };

    const sounds = {
      mus: $('aud_mus').value || '',
      ding: $('aud_ding').value || '',
      buzz: $('aud_buzz').value || '',
      coin: $('aud_coin').value || '',
      crash: $('aud_crash').value || '',
      win: $('aud_win').value || ''
    };

    const qLines = parseLines($('q_col').value);
    const cLines = parseLines($('c_col').value);
    const wLines = parseLines($('w_col').value);

    const tasks = [];
    const n = Math.max(qLines.length, cLines.length, wLines.length);
    for(let i=0;i<n;i++){
      const question = (qLines[i]||'').trim();
      const c = (cLines[i]||'').trim();
      const w = (wLines[i]||'').trim();
      if(!question && !c && !w) continue;

      const correct = (c ? c.split('|') : ['OK']).map(s=>s.trim()).filter(Boolean);
      const wrong = (w ? w.split('|') : ['NO']).map(s=>s.trim()).filter(Boolean);

      tasks.push({ question: question || '...', correct, wrong });
    }

    return { lang, mode, math, transparentBg, randomQuestions, ui, gameplay, assets, sounds, tasks };
  }

  function validate(cfg){
    if(!cfg.tasks.length) return (cfg.lang === 'ru') ? '–î–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã 1 –∑–∞–¥–∞–Ω–∏–µ.' : 'Add at least 1 task.';
    if(cfg.mode === 'input'){
      const bad = cfg.tasks.find(t => !t.correct || !t.correct.length || !t.correct[0]);
      if(bad) return (cfg.lang === 'ru') ? '–í —Ä–µ–∂–∏–º–µ ‚Äú–í–ø–∏—à–∏ –æ—Ç–≤–µ—Ç‚Äù –≤ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω —Å—Ç–æ–ª–±–µ—Ü ‚Äú–í–µ—Ä–Ω–æ‚Äù.' : 'In input mode, every row must have ‚ÄúCorrect‚Äù.';
    }
    return '';
  }

  // emoji quick insert
  let lastFocusedEl = null;
  document.addEventListener('focusin', (e)=>{
    const el = e.target;
    if(el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA')) lastFocusedEl = el;
  });
  function insertAtCursor(text){
    const el = lastFocusedEl;
    if(!el) return;
    const start = el.selectionStart ?? el.value.length;
    const end = el.selectionEnd ?? el.value.length;
    el.value = el.value.slice(0,start) + text + el.value.slice(end);
    el.focus();
    el.selectionStart = el.selectionEnd = start + text.length;
    queuePreview();
  }
  const HERO_EMO = ["üêë","üêê","ü¶ô","üêï","üêà","ü¶ä","üêâ","ü§ñ","üßô‚Äç‚ôÄÔ∏è","üßô‚Äç‚ôÇÔ∏è"];
  function mountEmojiBar(){
    const bar = $('heroEmojiBar');
    if(!bar) return;
    bar.innerHTML = '';
    HERO_EMO.forEach(e=>{
      const b = document.createElement('button');
      b.className='emojiBtn';
      b.type='button';
      b.textContent=e;
      b.onclick=()=>{ $('hero').focus(); insertAtCursor(e); };
      bar.appendChild(b);
    });
  }

  // preview
  let previewTimer = null;
  function queuePreview(){
    if(previewTimer) clearTimeout(previewTimer);
    previewTimer = setTimeout(refreshPreview, 180);
  }

  function refreshPreview(){
    const cfg = collectConfig();
    const err = validate(cfg);
    if(err){
      $('statusPill').textContent = (I18N[$('uiLang').value]?.stErr || '–û—à–∏–±–∫–∞');
      return;
    }
    const pr = $('preview');
    pr.dataset.pendingCfg = JSON.stringify(cfg);
    pr.src = BASE_MAIN + "?preview=1&v=" + Date.now();
    $('statusPill').textContent = (I18N[$('uiLang').value]?.stReady || '–ì–æ—Ç–æ–≤–æ');
  }

  let lastIframe = "";

  async function publish(){
    const cfg = collectConfig();
    const err = validate(cfg);
    if(err){ alert(err); $('statusPill').textContent = I18N[$('uiLang').value]?.stErr || '–û—à–∏–±–∫–∞'; return; }

    $('statusPill').textContent = I18N[$('uiLang').value]?.stPub || '–°–æ–∑–¥–∞—é‚Ä¶';

    const id = makeIdFromTitle(cfg);
    const payload = {
      id,
      mode: "json",
      folder: "data",
      content: JSON.stringify(cfg, null, 2)
    };

    try{
      const res = await fetch(ENDPOINT, {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "X-Publish-Key": PUBLISH_KEY
        },
        body: JSON.stringify(payload)
      });

      if(!res.ok){
        const t = await res.text().catch(()=>res.statusText);
        throw new Error(t || "Server error");
      }

      lastIframe =
`<iframe
  src="${BASE_MAIN}?id=${encodeURIComponent(id)}"
  width="100%"
  height="650"
  style="border:0;display:block;background:transparent;"
  allow="autoplay; fullscreen"
  sandbox="allow-scripts allow-same-origin allow-forms"
></iframe>`;

      $('statusPill').textContent = I18N[$('uiLang').value]?.stWait || '–ì–æ—Ç–æ–≤–æ ‚úÖ';
      toast(cfg.lang === 'ru' ? '–ò–≥—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞ ‚úÖ' : 'Game generated ‚úÖ');
    }catch(e){
      $('statusPill').textContent = I18N[$('uiLang').value]?.stErr || '–û—à–∏–±–∫–∞';
      alert((cfg.lang === 'ru' ? '–°–µ—Ç—å/—Å–µ—Ä–≤–µ—Ä: ' : 'Network/server: ') + e.message);
    }
  }

  async function copyIframe(){
    const editorLang = $('uiLang').value;
    const lang = $('gameLang') ? $('gameLang').value : editorLang;
    if(!lastIframe){
      toast(lang === 'ru' ? '–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∏–≥—Ä—É' : 'Generate the game first');
      return;
    }
    try{
      await navigator.clipboard.writeText(lastIframe);
      toast(lang === 'ru' ? '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!' : 'Copied!');
    }catch(e){
      const ta = document.createElement('textarea');
      ta.value = lastIframe;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      toast(lang === 'ru' ? '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!' : 'Copied!');
    }
  }

  // tabs
  (function(){
    const tabs = document.querySelectorAll('#tabs .tab');
    const panels = document.querySelectorAll('.left .tabPanel');
    function activate(name){
      tabs.forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
      panels.forEach(p=>p.classList.toggle('active', p.dataset.panel===name));
    }
    tabs.forEach(b=>b.addEventListener('click', ()=>activate(b.dataset.tab)));
  })();

  // ===== NEW: show computed values in UI =====
  function updateSpeedUI(){
    const s = parseFloat($('spawnBase')?.value || '8.5');
    const m = parseFloat($('moveBase')?.value || '6.0');

    if($('spawnBaseVal')) $('spawnBaseVal').textContent = String(s);
    if($('spawnMedVal'))  $('spawnMedVal').textContent  = (s * DIFF_MED_MULT).toFixed(1);
    if($('spawnHardVal')) $('spawnHardVal').textContent = (s * DIFF_HARD_MULT).toFixed(1);

    if($('moveBaseVal')) $('moveBaseVal').textContent = String(m.toFixed(1));
    if($('moveMedVal'))  $('moveMedVal').textContent  = (m * DIFF_MED_MULT).toFixed(1);
    if($('moveHardVal')) $('moveHardVal').textContent = (m * DIFF_HARD_MULT).toFixed(1);
  }

  // init
  mountEmojiBar();
  applyLang($('uiLang').value);
  $('fontSizeVal').textContent = $('fontSize').value;

  updateSpeedUI();

  $('spawnBase')?.addEventListener('input', ()=>{ updateSpeedUI(); queuePreview(); });
  $('moveBase')?.addEventListener('input',  ()=>{ updateSpeedUI(); queuePreview(); });

  $('preview').addEventListener('load', ()=>{
    try{
      const raw = $('preview').dataset.pendingCfg;
      if(!raw) return;
      const cfg = JSON.parse(raw);
      $('preview').contentWindow.postMessage({ type:'SHEEP_CFG', cfg }, '*');
    }catch(e){}
  });

  refreshPreview();

  $('btnPreview').addEventListener('click', refreshPreview);
  $('btnPublish').addEventListener('click', publish);
  $('btnGet').addEventListener('click', copyIframe);

  $('fontSize').addEventListener('input', ()=>{
    $('fontSizeVal').textContent = $('fontSize').value;
  });

  document.addEventListener('input', (e)=>{
    if(e.target && e.target.closest('.wrap')) queuePreview();
  });

  $('uiLang').addEventListener('change', ()=>{
    const editorLang = $('uiLang').value;
    applyLang(editorLang);
    queuePreview();
  });

  // default for smart replace when switching language of game UI
  window.__lastGameLang = $('gameLang').value || 'ru';

  $('gameLang').addEventListener('change', ()=>{
    const lang = $('gameLang').value;
    const prev = window.__lastGameLang || 'ru';
    const DEF = {
      ru:{start:'–ò–ì–†–ê–¢–¨', again:'–ï–©–Å –†–ê–ó', over:'–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê', score:'–°—á—ë—Ç: '},
      en:{start:'PLAY', again:'AGAIN', over:'GAME OVER', score:'Score: '},
      fr:{start:'JOUER', again:'REJOUER', over:'FIN DE PARTIE', score:'Score : '},
      de:{start:'SPIELEN', again:'NOCHMAL', over:'GAME OVER', score:'Punkte: '},
      es:{start:'JUGAR', again:'OTRA VEZ', over:'GAME OVER', score:'Puntuaci√≥n: '},
      it:{start:'GIOCA', again:'DI NUOVO', over:'GAME OVER', score:'Punteggio: '},
      zh:{start:'ÂºÄÂßã', again:'ÂÜçÊù•‰∏ÄÊ¨°', over:'Ê∏∏ÊàèÁªìÊùü', score:'ÂæóÂàÜÔºö'},
      ja:{start:'„Çπ„Çø„Éº„Éà', again:'„ÇÇ„ÅÜ‰∏ÄÂõû', over:'„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº', score:'„Çπ„Ç≥„Ç¢Ôºö'}
    };

    const prevD = DEF[prev] || DEF.ru;
    const curD  = DEF[lang] || DEF.ru;

    const startEl = $('ui_start'), againEl=$('ui_again'), overEl=$('ui_over'), scoreEl=$('ui_score');

    if(startEl.value === '' || startEl.value === prevD.start) startEl.value = curD.start;
    if(againEl.value === '' || againEl.value === prevD.again) againEl.value = curD.again;
    if(overEl.value  === '' || overEl.value  === prevD.over)  overEl.value  = curD.over;
    if(scoreEl.value === '' || scoreEl.value === prevD.score) scoreEl.value = curD.score;

    window.__lastGameLang = lang;
    queuePreview();
  });

  // ====== soft protection (not bulletproof): disable context menu & common devtools shortcuts ======
  (function(){
    const overlay = document.getElementById('devtoolsOverlay');
    const show = ()=>{ if(overlay) overlay.style.display='flex'; };
    const hide = ()=>{ if(overlay) overlay.style.display='none'; };

    document.addEventListener('contextmenu', (e)=>{ e.preventDefault(); toast('üö´'); }, {capture:true});

    document.addEventListener('keydown', (e)=>{
      const key = (e.key || '').toLowerCase();
      const isMac = /mac|iphone|ipad|ipod/i.test(navigator.platform);
      if(e.key === 'F12'){ e.preventDefault(); show(); return; }
      const ctrl = isMac ? e.metaKey : e.ctrlKey;

      if(ctrl && (key === 'u' || key === 's')){ e.preventDefault(); show(); return; }
      if(ctrl && e.shiftKey && (key === 'i' || key === 'j' || key === 'c')){ e.preventDefault(); show(); return; }
      if(ctrl && (key === 'i')){ e.preventDefault(); show(); return; }
    }, {capture:true});

    let last = 0;
    function tick(){
      const now = Date.now();
      if(now - last < 250) return;
      last = now;
      const w = Math.abs(window.outerWidth - window.innerWidth);
      const h = Math.abs(window.outerHeight - window.innerHeight);
      const open = (w > 160) || (h > 160);
      if(open) show(); else hide();
    }
    window.addEventListener('resize', tick);
    setInterval(tick, 900);
  })();

</script>
</body>
</html>
