<!DOCTYPE html>

<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Sheep Run ‚Äî –†–µ–¥–∞–∫—Ç–æ—Ä</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&amp;family=Montserrat:wght@400;700;900&amp;display=swap" rel="stylesheet"/>
<style>
    :root{
      --primary:#00E5FF;
      --accent:#FF4081;
      --glass:rgba(255,255,255,0.95);
      --dark:#121212;
      --bg1:#2a003b;
      --bg2:#000;
      --stroke:rgba(0,0,0,.08);
      --panel:rgba(255,255,255,.70);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Montserrat',sans-serif;
      background: radial-gradient(circle at center, var(--bg1) 0%, var(--bg2) 100%);
      padding:22px 14px;
      min-height:100vh;
      color:#222;
    }
    .bg-float{position:fixed;font-size:46px;opacity:.18;z-index:-1;animation:floatSpace 24s infinite linear}
    @keyframes floatSpace{0%{transform:translateY(110vh) rotate(0deg)}100%{transform:translateY(-10vh) rotate(360deg)}}

    .wrap{
      max-width:1200px;
      margin:0 auto;
      background:var(--glass);
      border-radius:22px;
      border:2px solid rgba(255,255,255,0.12);
      box-shadow:0 0 18px var(--primary), 0 0 60px rgba(0,229,255,.18);
      overflow:hidden;
    }

    /* Top header */
    .header{
      display:flex; align-items:center; justify-content:space-between;
      padding:16px 18px 12px;
      background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.65));
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logoWrap{width:44px;height:44px;border-radius:14px;background:#fff;display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(0,0,0,.08); box-shadow:0 10px 25px rgba(0,0,0,.08);
      font-size:26px;
    }
    h1{margin:0;font-family:'Fredoka One',cursive;font-size:34px;letter-spacing:.02em}
    .mini{margin-top:2px;font-size:12px;color:#444;opacity:.9;font-weight:700}
    .by{margin-top:2px;font-size:12px;color:#666;opacity:.9}
    .headerRight{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    label{font-weight:900;font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:#444}
    select,input[type=text],textarea{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:2px solid #ddd;
      font-family:'Montserrat',sans-serif;
      outline:none;
      transition:.2s;
      background:white;
      font-size:14px;
    }
    textarea{min-height:120px; resize:vertical; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    select:focus,input:focus,textarea:focus{border-color:var(--primary);box-shadow:0 0 10px rgba(0,229,255,.22)}
    .statusPill{
      padding:10px 14px;
      border-radius:999px;
      background:rgba(0,0,0,.06);
      border:1px solid rgba(0,0,0,.08);
      font-weight:900;
      font-size:13px;
      color:#333;
      min-width:110px;
      text-align:center;
    }

    .main{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:14px;
      padding:14px;
    }

    /* Sidebar */
    .sidebar{
      background:var(--panel);
      border:1px solid rgba(0,0,0,.08);
      border-radius:18px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      height: calc(100vh - 160px);
      min-height: 520px;
    }
    .tabbar{
      display:flex; flex-wrap:wrap; gap:6px;
      padding:10px;
      background:rgba(255,255,255,.85);
      border-bottom:1px solid rgba(0,0,0,.08);
      position:sticky;
      top:0;
      z-index:5;
    }
    .tabBtn{
      border:none;
      cursor:pointer;
      padding:10px 12px;
      border-radius:12px 12px 0 0;
      background:rgba(255,255,255,.65);
      border:1px solid rgba(0,0,0,.10);
      font-weight:900;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#333;
    }
    .tabBtn.active{
      background:white;
      border-bottom-color:white;
      box-shadow:0 -4px 14px rgba(0,0,0,.08);
    }
    .sideScroll{
      padding:12px;
      overflow:auto;
      flex:1;
    }

    .card{
      background:rgba(255,255,255,.75);
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      padding:14px;
      margin-bottom:12px;
    }
    .card h2{
      margin:0 0 10px;
      font-size:15px;
      display:flex; align-items:center; gap:10px;
      border-bottom:2px solid var(--primary);
      padding-bottom:8px;
    }
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .help{font-size:12px;color:#555;opacity:.92;margin-top:6px;line-height:1.35}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .checkRow{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .chk{display:flex;align-items:center;gap:8px;font-weight:900;font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:#444}
    .chk input{width:18px;height:18px}

    /* Emoji buttons */
    .emojiBar{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .emojiBtn{width:36px;height:36px;border-radius:10px;border:1px solid rgba(0,0,0,.15);background:white;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;transition:.1s}
    .emojiBtn:hover{transform:translateY(-1px)}

    /* Preview area */
    .previewArea{
      background:rgba(255,255,255,.55);
      border:1px solid rgba(0,0,0,.08);
      border-radius:18px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:520px;
    }
    .actions{
      display:flex; gap:10px; align-items:center; justify-content:flex-start;
      padding:12px;
      background:rgba(255,255,255,.85);
      border-bottom:1px solid rgba(0,0,0,.08);
      flex-wrap:wrap;
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:12px 16px;
      cursor:pointer;
      font-family:'Fredoka One',cursive;
      font-size:14px;
      text-transform:uppercase;
      letter-spacing:.06em;
      background:linear-gradient(45deg, var(--primary), #00B8D4);
      color:white;
      box-shadow:0 5px 15px rgba(0,229,255,.30);
      transition:.12s;
    }
    .btn:hover{transform:scale(1.01)}
    .btn:active{transform:scale(.98)}
    .btn.alt{background:#222; box-shadow:none}
    .btn.alt2{background:#444; box-shadow:none}

    .previewWrap{
      flex:1;
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.05);
    }
    .ratio16x9{
      width:100%;
      max-width: 900px;
      aspect-ratio: 16 / 9;
      background: rgba(255,255,255,.25);
      border:1px dashed rgba(0,0,0,.18);
      border-radius:16px;
      padding:10px;
      display:flex;
    }
    iframe#preview{
      width:100%;
      height:100%;
      border:0;
      border-radius:12px;
      background:transparent;
      display:block;
    }

    .footer{
      padding:10px 14px;
      text-align:center;
      font-size:12px;
      color:rgba(0,0,0,.55);
      border-top:1px solid rgba(0,0,0,.06);
      background:rgba(255,255,255,.65);
    }
    .footer b{color:#111}

    /* Sections */
    .tabSection{display:none}
    .tabSection.active{display:block}
  </style>
</head>
<body>
<div class="bg-float" style="left:10%; animation-duration: 26s;">üêë</div>
<div class="bg-float" style="left:82%; animation-duration: 30s; animation-delay:-7s;">üöÄ</div>
<div class="bg-float" style="left:30%; animation-duration: 22s; animation-delay:-12s;">ü™ê</div>
<div class="bg-float" style="left:60%; animation-duration: 28s; animation-delay:-3s;">üëæ</div>
<div class="wrap">
<div class="header">
<div class="brand">
<div aria-hidden="true" class="logoWrap">üêë</div>
<div>
<h1 id="uiHeaderTitle">SHEEP RUN</h1>
<div class="mini" id="uiHeaderMini">–†–µ–¥–∞–∫—Ç–æ—Ä –∏–≥—Ä—ã</div>
<div class="by"><b>@teachy_witchy</b></div>
</div>
</div>
<div class="headerRight">
<div style="display:flex;align-items:center;gap:10px">
<label id="lblLang">–Ø–∑—ã–∫</label>
<select id="uiLang" style="min-width:170px">
<option selected="" value="ru">–†—É—Å—Å–∫–∏–π</option>
<option value="en">English</option>
<option value="fr">Fran√ßais</option>
<option value="de">Deutsch</option>
<option value="es">Espa√±ol</option>
<option value="it">Italiano</option>
<option value="zh">‰∏≠Êñá</option>
<option value="ja">Êó•Êú¨Ë™û</option>
</select>
</div>
<div class="statusPill" id="statusPill">–ì–æ—Ç–æ–≤–æ</div>
</div>
</div>
<div class="main">
<!-- LEFT -->
<aside class="sidebar">
<div aria-label="–†–∞–∑–¥–µ–ª—ã" class="tabbar" role="tablist">
<button class="tabBtn active" data-tab="settings" id="tab-settings" type="button">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
<button class="tabBtn" data-tab="tasks" id="tab-tasks" type="button">–ó–∞–¥–∞–Ω–∏—è</button>
<button class="tabBtn" data-tab="images" id="tab-images" type="button">–ö–∞—Ä—Ç–∏–Ω–∫–∏</button>
<button class="tabBtn" data-tab="sounds" id="tab-sounds" type="button">–ó–≤—É–∫–∏</button>
</div>
<div class="sideScroll">
<!-- SETTINGS (merged) -->
<section class="tabSection active" data-tab="settings" id="sec-settings">
<div class="card">
<h2>‚öôÔ∏è <span id="tGame">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></h2>
<div class="grid2">
<div>
<label id="lblMode">–†–µ–∂–∏–º</label>
<select id="gameMode">
<option selected="" value="choice">–ö–Ω–æ–ø–∫–∏ (A/B)</option>
<option value="input">–í–ø–∏—à–∏ –æ—Ç–≤–µ—Ç</option>
</select>
</div>
<div>
<label id="lblWin">–°–∫–æ–ª—å–∫–æ –∑–∞–¥–∞–Ω–∏–π –¥–æ –ø–æ–±–µ–¥—ã</label>
<input id="winQuestions" type="text" value="10"/>
</div>
</div>
<div class="checkRow" style="margin-top:10px">
<label class="chk"><input id="mathMode" type="checkbox"/><span id="lblMath">MathJax</span></label>
<label class="chk"><input id="transparentBg" type="checkbox"/><span id="lblTransparent">–ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω</span></label>
</div>
</div>
<div class="card">
<h2>üß© <span id="tUi">–¢–µ–∫—Å—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</span></h2>
<div class="grid2">
<div><label id="lTitle">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="ui_title" type="text" value="SHEEP RUN"/></div>
<div><label id="lStart">–ö–Ω–æ–ø–∫–∞ –°—Ç–∞—Ä—Ç</label><input id="ui_start" type="text" value="PLAY"/></div>
<div><label id="lAgain">–ö–Ω–æ–ø–∫–∞ –ü–æ–≤—Ç–æ—Ä</label><input id="ui_again" type="text" value="AGAIN"/></div>
<div><label id="lOver">–¢–µ–∫—Å—Ç –ø—Ä–∏ –ø—Ä–æ–∏–≥—Ä—ã—à–µ</label><input id="ui_over" type="text" value="GAME OVER"/></div>
<div style="grid-column:1 / -1"><label id="lScore">–ü–æ–¥–ø–∏—Å—å —Å—á—ë—Ç–∞</label><input id="ui_score" type="text" value="Score: "/></div>
</div>
<div class="help" id="hLangFill">–Ø–∑—ã–∫ –º–æ–∂–µ—Ç –ø–æ–¥—Å—Ç–∞–≤–ª—è—Ç—å –±–∞–∑–æ–≤—ã–µ –Ω–∞–¥–ø–∏—Å–∏. –ï—Å–ª–∏ –≤–ø–∏—Å–∞–ª–∏ —Å–≤–æ—ë ‚Äî –æ—Å—Ç–∞—ë—Ç—Å—è –≤–∞—à–µ.</div>
</div>
</section>
<!-- TASKS -->
<section class="tabSection" data-tab="tasks" id="sec-tasks">
<div class="card">
<h2>üìù <span id="tQ">–ó–∞–¥–∞–Ω–∏—è</span></h2>
<div class="help" id="hQ">–ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ = –æ–¥–Ω–æ –∑–∞–¥–∞–Ω–∏–µ. –í ¬´–í–µ—Ä–Ω–æ¬ª –º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ <b>|</b>. –ï—Å–ª–∏ –≤—Å—Ç–∞–≤–∏–ª–∏ —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É ‚Äî –æ–Ω–∞ –ø–æ–∫–∞–∂–µ—Ç—Å—è –∫–∞–∫ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –≤ –∏–≥—Ä–µ.</div>
<div class="checkRow" style="margin:10px 0 6px">
<label class="chk"><input id="randomQuestions" type="checkbox"/><span id="lblRandom">–†–∞–Ω–¥–æ–º –≤–æ–ø—Ä–æ—Å–æ–≤</span></label>
</div>
<div class="row" style="margin:8px 0 10px">
<div style="flex:1">
<label id="lblFontSize">–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –∑–∞–¥–∞–Ω–∏–π</label>
<input id="fontSize" type="text" value="8">
<div class="help" id="hFont">–ß–∏—Å–ª–æ. –ü—Ä–∏–º–µ—Ä: 7‚Äì10 –¥–ª—è –º–∞–ª–µ–Ω—å–∫–æ–≥–æ —ç–∫—Ä–∞–Ω–∞, 10‚Äì14 –¥–ª—è –∫—Ä—É–ø–Ω–æ–≥–æ.</div>
</input></div>
</div>
<div style="display:flex;flex-direction:column;gap:10px">
<div>
<label id="lQ">–í–æ–ø—Ä–æ—Å</label>
<textarea id="q_col" placeholder="Dog ___ fast."></textarea>
</div>
<div>
<label id="lC">–í–µ—Ä–Ω–æ</label>
<textarea id="c_col" placeholder="runs"></textarea>
</div>
<div>
<label id="lW">–ù–µ–≤–µ—Ä–Ω–æ</label>
<textarea id="w_col" placeholder="run"></textarea>
</div>
</div>
</div>
</section>
<!-- IMAGES -->
<section class="tabSection" data-tab="images" id="sec-images">
<div class="card">
<h2>üñºÔ∏è <span id="tAssets">–ö–∞—Ä—Ç–∏–Ω–∫–∏</span></h2>
<div class="help" id="hAssets">–ú–æ–∂–Ω–æ —ç–º–æ–¥–∑–∏ –∏–ª–∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏/–≥–∏—Ñ. –°–ø–∏—Å–∫–∏ ‚Äî —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –∏–ª–∏ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏.</div>
<div style="margin-top:10px">
<label id="lHero">–ü–µ—Ä—Å–æ–Ω–∞–∂</label>
<input id="hero" type="text" value="üêë"/>
<div class="emojiBar" id="heroEmojiBar"></div>
<div class="checkRow" style="margin-top:10px">
<label class="chk"><input id="mirrorHero" type="checkbox"/><span id="lblMirror">–û—Ç—Ä–∞–∑–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</span></label>
</div>
</div>
<div class="grid3" style="margin-top:10px">
<div>
<label id="lGround">–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è (–∑–µ–º–ª—è)</label>
<textarea id="obs_ground">üå≤,ü™®,ü™µ,üåµ</textarea>
</div>
<div>
<label id="lGood">–•–æ—Ä–æ—à–∏–µ (–ª–µ—Ç—è—Ç)</label>
<textarea id="obs_good">üåæ,üåΩ,üçÄ,üçé</textarea>
</div>
<div>
<label id="lBad">–ü–ª–æ—Ö–∏–µ (–ª–µ—Ç—è—Ç)</label>
<textarea id="obs_bad">ü¶Ö,üß±,üöÅ,‚õàÔ∏è</textarea>
</div>
</div>
</div>
</section>
<!-- SOUNDS -->
<section class="tabSection" data-tab="sounds" id="sec-sounds">
<div class="card">
<h2>üîä <span id="tAudio">–ó–≤—É–∫–∏</span></h2>
<div class="help" id="hAudio">–í—Å—Ç–∞–≤–ª—è–π –ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ mp3/ogg. –ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º ‚Äî –∏–≥—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ—Å—Ç—ã–µ –∑–≤—É–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.</div>
<div class="grid2">
<div><label>Music</label><input id="aud_mus" type="text" value="https://raw.githubusercontent.com/kgbgamelab/audioplayer/main/Baa%20Dash.mp3"/></div>
<div><label>Ding</label><input id="aud_ding" type="text" value="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"/></div>
<div><label>Buzz</label><input id="aud_buzz" type="text" value="https://assets.mixkit.co/active_storage/sfx/257/257-preview.mp3"/></div>
<div><label>Coin</label><input id="aud_coin" type="text" value="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"/></div>
<div><label>Crash</label><input id="aud_crash" type="text" value="https://assets.mixkit.co/active_storage/sfx/2042/2042-preview.mp3"/></div>
<div><label>Win</label><input id="aud_win" type="text" value="https://assets.mixkit.co/active_storage/sfx/2018/2018-preview.mp3"/></div>
</div>
</div>
</section>
</div>
<div class="footer">¬© 2026 <b>–ö–æ—Ä–ø–æ—Ä–∞—Ü–∏—è –ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ë—É–¥—É—â–µ–≥–æ</b> ¬∑ <b>@teachy_witchy</b></div>
</aside>
<!-- RIGHT -->
<section class="previewArea">
<div class="actions">
<button class="btn alt2" id="btnPreview" onclick="refreshPreview()" type="button">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é</button>
<button class="btn" id="btnPublish" onclick="publish()" type="button">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä—É</button>
<button class="btn alt" id="btnGet" onclick="copyIframe()" type="button">–ü–æ–ª—É—á–∏—Ç—å –∏–≥—Ä—É</button>
</div>
<div class="previewWrap">
<div class="ratio16x9">
<iframe allow="autoplay; fullscreen" id="preview" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
</div>
</div>
</section>
</div>
</div>
<script>

  // ====== CONFIG ======
  // –î–≤–∏–∂–æ–∫ –∏–≥—Ä—ã (main.html) –ª–µ–∂–∏—Ç –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ puk.
  const BASE_MAIN = "https://nikashum93.github.io/puk/main.html";

  // –ü—É–±–ª–∏–∫–∞—Ü–∏—è (–∫–∞–∫ –≤ —Ç–≤–æ–∏—Ö —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–∞—Ö) ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä,
  // –∫–æ—Ç–æ—Ä—ã–π –∫–ª–∞–¥—ë—Ç —Ñ–∞–π–ª –≤ nikashum93/texts/data/<id>.json
  const ENDPOINT    = "https://server-kjnn.onrender.com/publish";
  const PUBLISH_KEY = "nika_read_pub_2025";

  // ====== i18n (teacher-friendly) ======
  const I18N = {
    ru: {
      mini: "–†–µ–¥–∞–∫—Ç–æ—Ä –∏–≥—Ä—ã",
      lang:"–Ø–∑—ã–∫", mode:"–†–µ–∂–∏–º", win:"–°–∫–æ–ª—å–∫–æ –∑–∞–¥–∞–Ω–∏–π –¥–æ –ø–æ–±–µ–¥—ã",
      math:"MathJax", transparent:"–ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω", mirror:"–û—Ç—Ä–∞–∑–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞", random:"–†–∞–Ω–¥–æ–º –≤–æ–ø—Ä–æ—Å–æ–≤",
      tGame:"–ù–∞—Å—Ç—Ä–æ–π–∫–∏", tUi:"–¢–µ–∫—Å—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞", tAssets:"–ü–µ—Ä—Å–æ–Ω–∞–∂ –∏ –ø—Ä–µ–¥–º–µ—Ç—ã", tAudio:"–ó–≤—É–∫–∏", tQ:"–ó–∞–¥–∞–Ω–∏—è",
      title:"–ù–∞–∑–≤–∞–Ω–∏–µ", start:"–ö–Ω–æ–ø–∫–∞ –°—Ç–∞—Ä—Ç", again:"–ö–Ω–æ–ø–∫–∞ –ü–æ–≤—Ç–æ—Ä", over:"–¢–µ–∫—Å—Ç –ø—Ä–∏ –ø—Ä–æ–∏–≥—Ä—ã—à–µ", score:"–ü–æ–¥–ø–∏—Å—å —Å—á—ë—Ç–∞",
      q:"–í–æ–ø—Ä–æ—Å", c:"–í–µ—Ä–Ω–æ", w:"–ù–µ–≤–µ—Ä–Ω–æ",
      assetsHelp:"–ú–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å —ç–º–æ–¥–∑–∏ (üêë) –∏–ª–∏ –≤—Å—Ç–∞–≤–ª—è—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É/–≥–∏—Ñ (https://...). –°–ø–∏—Å–∫–∏ ‚Äî —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –∏–ª–∏ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏.",
      audioHelp:"–ï—Å–ª–∏ —Å—Å—ã–ª–∫–∏ –ø—É—Å—Ç—ã–µ ‚Äî –∏–≥—Ä–∞ –≤—Å—ë —Ä–∞–≤–Ω–æ –±—É–¥–µ—Ç —Å–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ –∑–≤—É–∫–∞–º–∏. –ú—É–∑—ã–∫–∞ ‚Äî –ø–æ –∂–µ–ª–∞–Ω–∏—é.",
      qHelp:"–í—Å—Ç–∞–≤–ª—è–π –∏–∑ Excel: –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ = –æ–¥–Ω–æ –∑–∞–¥–∞–Ω–∏–µ. –í ‚Äú–í–µ—Ä–Ω–æ‚Äù –º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ |. –í —Ä–µ–∂–∏–º–µ ‚Äú–í–ø–∏—à–∏ –æ—Ç–≤–µ—Ç‚Äù –∫–æ–ª–æ–Ω–∫–∞ ‚Äú–ù–µ–≤–µ—Ä–Ω–æ‚Äù –Ω–µ –Ω—É–∂–Ω–∞.",
      btnPrev:"–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é", btnPub:"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä—É", btnGet:"–ü–æ–ª—É—á–∏—Ç—å –∏–≥—Ä—É",
      stReady:"–ì–æ—Ç–æ–≤–æ", stPub:"–°–æ–∑–¥–∞—é‚Ä¶", stErr:"–û—à–∏–±–∫–∞", stWait:"–ì–æ—Ç–æ–≤–æ ‚úÖ"
    },
    en: {
      mini: "Game editor",
      lang:"Language", mode:"Mode", win:"Tasks to win",
      math:"MathJax", transparent:"Transparent BG", mirror:"Mirror hero", random:"Random order",
      tGame:"Settings", tUi:"UI texts", tAssets:"Hero & items", tAudio:"Audio", tQ:"Tasks",
      title:"Title", start:"Start button", again:"Again button", over:"Lose text", score:"Score label",
      q:"Question", c:"Correct", w:"Wrong",
      assetsHelp:"Use emoji (üêë) or an image/gif URL (https://...). Lists: commas or new lines.",
      audioHelp:"If URLs are empty, the game still has simple built-in sounds. Music is optional.",
      qHelp:"Paste from Excel: one line = one task. ‚ÄúCorrect‚Äù can include multiple options via |. In input mode, ‚ÄúWrong‚Äù is not required.",
      btnPrev:"Refresh preview", btnPub:"Generate game", btnGet:"Get game",
      stReady:"Ready", stPub:"Generating‚Ä¶", stErr:"Error", stWait:"Done ‚úÖ"
    },
    fr: {
      mini: "√âditeur de jeu",
      lang:"Langue", mode:"Mode", win:"D√©fis pour gagner",
      math:"MathJax", transparent:"Fond transparent", mirror:"Miroir du h√©ros", random:"Ordre al√©atoire",
      tGame:"R√©glages", tUi:"Textes UI", tAssets:"H√©ros & objets", tAudio:"Audio", tQ:"D√©fis",
      title:"Titre", start:"Bouton Start", again:"Rejouer", over:"Texte d√©faite", score:"Libell√© score",
      q:"Question", c:"Correct", w:"Faux",
      assetsHelp:"Utilise des emoji (üêë) ou un lien d'image/gif (https://...). Listes : virgules ou nouvelles lignes.",
      audioHelp:"Si les liens sont vides, le jeu aura quand m√™me des sons int√©gr√©s. La musique est optionnelle.",
      qHelp:"Colle depuis Excel : 1 ligne = 1 d√©fi. ‚ÄúCorrect‚Äù peut contenir plusieurs r√©ponses via |. En mode saisie, ‚ÄúFaux‚Äù n'est pas obligatoire.",
      btnPrev:"Rafra√Æchir l'aper√ßu", btnPub:"G√©n√©rer le jeu", btnGet:"Obtenir le jeu",
      stReady:"Pr√™t", stPub:"G√©n√©ration‚Ä¶", stErr:"Erreur", stWait:"Termin√© ‚úÖ"
    },
    de: {
      mini: "Spiel-Editor",
      lang:"Sprache", mode:"Modus", win:"Aufgaben bis zum Sieg",
      math:"MathJax", transparent:"Transparenter Hintergrund", mirror:"Held spiegeln", random:"Zuf√§llige Reihenfolge",
      tGame:"Einstellungen", tUi:"UI-Texte", tAssets:"Held & Items", tAudio:"Audio", tQ:"Aufgaben",
      title:"Titel", start:"Start-Taste", again:"Nochmal", over:"Text bei Verlust", score:"Punkte-Label",
      q:"Frage", c:"Richtig", w:"Falsch",
      assetsHelp:"Emoji (üêë) oder Bild/GIF-URL (https://...). Listen: Kommas oder neue Zeilen.",
      audioHelp:"Wenn URLs leer sind, hat das Spiel trotzdem einfache Sounds. Musik ist optional.",
      qHelp:"Aus Excel einf√ºgen: 1 Zeile = 1 Aufgabe. ‚ÄúRichtig‚Äù kann mehrere Optionen via | haben. Im Eingabemodus ist ‚ÄúFalsch‚Äù nicht n√∂tig.",
      btnPrev:"Vorschau aktualisieren", btnPub:"Spiel erzeugen", btnGet:"Spiel holen",
      stReady:"Bereit", stPub:"Erzeuge‚Ä¶", stErr:"Fehler", stWait:"Fertig ‚úÖ"
    },
    es: {
      mini: "Editor del juego",
      lang:"Idioma", mode:"Modo", win:"Tareas para ganar",
      math:"MathJax", transparent:"Fondo transparente", mirror:"Espejar personaje", random:"Orden aleatorio",
      tGame:"Ajustes", tUi:"Textos UI", tAssets:"Personaje y objetos", tAudio:"Audio", tQ:"Tareas",
      title:"T√≠tulo", start:"Bot√≥n Start", again:"Otra vez", over:"Texto al perder", score:"Etiqueta de puntuaci√≥n",
      q:"Pregunta", c:"Correcto", w:"Incorrecto",
      assetsHelp:"Usa emoji (üêë) o URL de imagen/gif (https://...). Listas: comas o saltos de l√≠nea.",
      audioHelp:"Si las URLs est√°n vac√≠as, el juego igual tendr√° sonidos b√°sicos. La m√∫sica es opcional.",
      qHelp:"Pega desde Excel: 1 l√≠nea = 1 tarea. ‚ÄúCorrecto‚Äù puede tener varias opciones con |. En modo escribir, ‚ÄúIncorrecto‚Äù no es obligatorio.",
      btnPrev:"Actualizar vista previa", btnPub:"Generar juego", btnGet:"Obtener juego",
      stReady:"Listo", stPub:"Generando‚Ä¶", stErr:"Error", stWait:"Hecho ‚úÖ"
    },
    it: {
      mini: "Editor del gioco",
      lang:"Lingua", mode:"Modalit√†", win:"Prove per vincere",
      math:"MathJax", transparent:"Sfondo trasparente", mirror:"Specchia eroe", random:"Ordine casuale",
      tGame:"Impostazioni", tUi:"Testi UI", tAssets:"Eroe e oggetti", tAudio:"Audio", tQ:"Prove",
      title:"Titolo", start:"Pulsante Start", again:"Di nuovo", over:"Testo sconfitta", score:"Etichetta punteggio",
      q:"Domanda", c:"Corretto", w:"Sbagliato",
      assetsHelp:"Usa emoji (üêë) o URL immagine/gif (https://...). Liste: virgole o nuove righe.",
      audioHelp:"Se le URL sono vuote, il gioco avr√† comunque suoni base. La musica √® opzionale.",
      qHelp:"Incolla da Excel: 1 riga = 1 prova. ‚ÄúCorretto‚Äù pu√≤ includere pi√π opzioni con |. In modalit√† input, ‚ÄúSbagliato‚Äù non √® obbligatorio.",
      btnPrev:"Aggiorna anteprima", btnPub:"Genera gioco", btnGet:"Ottieni gioco",
      stReady:"Pronto", stPub:"Generazione‚Ä¶", stErr:"Errore", stWait:"Fatto ‚úÖ"
    },
    zh: {
      mini: "Ê∏∏ÊàèÁºñËæëÂô®",
      lang:"ËØ≠Ë®Ä", mode:"Ê®°Âºè", win:"Ëé∑ËÉúÈ¢òÊï∞",
      math:"MathJax", transparent:"ÈÄèÊòéËÉåÊôØ", mirror:"ÈïúÂÉèËßíËâ≤", random:"ÈöèÊú∫È°∫Â∫è",
      tGame:"ËÆæÁΩÆ", tUi:"ÁïåÈù¢ÊñáÂ≠ó", tAssets:"ËßíËâ≤‰∏éÁâ©ÂìÅ", tAudio:"Èü≥È¢ë", tQ:"È¢òÁõÆ",
      title:"Ê†áÈ¢ò", start:"ÂºÄÂßãÊåâÈíÆ", again:"ÂÜçÊù•‰∏ÄÊ¨°", over:"Â§±Ë¥•ÊñáÂ≠ó", score:"ÂàÜÊï∞Ê†áÁ≠æ",
      q:"ÈóÆÈ¢ò", c:"Ê≠£Á°Æ", w:"ÈîôËØØ",
      assetsHelp:"ÂèØÁî®Ë°®ÊÉÖ(üêë)ÊàñÂõæÁâá/Âä®ÂõæÈìæÊé•(https://...)„ÄÇÂàóË°®ÔºöÈÄóÂè∑ÊàñÊç¢Ë°å„ÄÇ",
      audioHelp:"Â¶ÇÊûúÈìæÊé•‰∏∫Á©∫ÔºåÊ∏∏Êàè‰ªçÊúâÂü∫Á°ÄÈü≥Êïà„ÄÇÈü≥‰πêÂèØÈÄâ„ÄÇ",
      qHelp:"‰ªé Excel Á≤òË¥¥Ôºö‰∏ÄË°å=‰∏ÄÈÅìÈ¢ò„ÄÇ‚ÄúÊ≠£Á°Æ‚ÄùÂèØÁî® | ÂÜôÂ§ö‰∏™Á≠îÊ°à„ÄÇËæìÂÖ•Ê®°Âºè‰∏ã‚ÄúÈîôËØØ‚Äù‰∏çÂøÖÂ°´„ÄÇ",
      btnPrev:"Âà∑Êñ∞È¢ÑËßà", btnPub:"ÁîüÊàêÊ∏∏Êàè", btnGet:"Ëé∑ÂèñÊ∏∏Êàè",
      stReady:"Â∞±Áª™", stPub:"ÁîüÊàê‰∏≠‚Ä¶", stErr:"ÈîôËØØ", stWait:"ÂÆåÊàê ‚úÖ"
    },
    ja: {
      mini: "„Ç≤„Éº„É†„Ç®„Éá„Ç£„Çø„Éº",
      lang:"Ë®ÄË™û", mode:"„É¢„Éº„Éâ", win:"ÂãùÂà©„Åæ„Åß„ÅÆÂïèÈ°åÊï∞",
      math:"MathJax", transparent:"ÈÄèÊòéËÉåÊôØ", mirror:"„Ç≠„É£„É©ÂèçËª¢", random:"„É©„É≥„ÉÄ„É†È†Ü",
      tGame:"Ë®≠ÂÆö", tUi:"UI„ÉÜ„Ç≠„Çπ„Éà", tAssets:"„Ç≠„É£„É©„Å®„Ç¢„Ç§„ÉÜ„É†", tAudio:"„Ç™„Éº„Éá„Ç£„Ç™", tQ:"ÂïèÈ°å",
      title:"„Çø„Ç§„Éà„É´", start:"„Çπ„Çø„Éº„Éà", again:"„ÇÇ„ÅÜ‰∏ÄÂõû", over:"Ë≤†„Åë„ÉÜ„Ç≠„Çπ„Éà", score:"„Çπ„Ç≥„Ç¢Ë°®Á§∫",
      q:"ÂïèÈ°å", c:"Ê≠£Ëß£", w:"‰∏çÊ≠£Ëß£",
      assetsHelp:"ÁµµÊñáÂ≠ó(üêë)„Åæ„Åü„ÅØÁîªÂÉè/GIF URL(https://...)„ÄÇ„É™„Çπ„ÉàÔºö„Ç´„É≥„Éû/ÊîπË°å„ÄÇ",
      audioHelp:"URL„ÅåÁ©∫„Åß„ÇÇÂü∫Êú¨ÂäπÊûúÈü≥„ÅØÂÖ•„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇÈü≥Ê•Ω„ÅØ‰ªªÊÑè„Åß„Åô„ÄÇ",
      qHelp:"Excel „Åã„ÇâË≤º„Çä‰ªò„ÅëÔºö1Ë°å=1Âïè„ÄÇ‚ÄúÊ≠£Ëß£‚Äù„ÅØ | „ÅßË§áÊï∞ÂèØ„ÄÇÂÖ•Âäõ„É¢„Éº„Éâ„Åß„ÅØ‚Äú‰∏çÊ≠£Ëß£‚Äù„ÅØ‰∏çË¶Å„Åß„Åô„ÄÇ",
      btnPrev:"„Éó„É¨„Éì„É•„ÉºÊõ¥Êñ∞", btnPub:"„Ç≤„Éº„É†ÁîüÊàê", btnGet:"„Ç≤„Éº„É†ÂèñÂæó",
      stReady:"Ê∫ñÂÇôOK", stPub:"ÁîüÊàê‰∏≠‚Ä¶", stErr:"„Ç®„É©„Éº", stWait:"ÂÆå‰∫Ü ‚úÖ"
    }
  };

  const $ = (id)=>document.getElementById(id);

  function setText(id, val){ const el = $(id); if(el) el.textContent = val; }
  function setHTML(id, val){ const el = $(id); if(el) el.innerHTML = val; }
  function setValue(id, val){ const el = $(id); if(el) el.value = val; }


  function toast(msg){
    const t = $('toast');
    if(!t){ try{ console.log(msg); }catch(e){} return; }
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 1400);
  }

  function applyLang(lang){
    const t = I18N[lang] || I18N.ru;
    setText('uiHeaderMini', t.mini);
    setText('lblLang', t.lang);

    setText('tGame', t.tGame);
    setText('lblMode', t.mode);
    setText('lblWin', t.win);
    setText('lblMath', t.math);
    setText('lblTransparent', t.transparent);
    setText('lblMirror', t.mirror);
    setText('lblRandom', t.random);

    setText('tUi', t.tUi);
    setText('lTitle', t.title);
    setText('lStart', t.start);
    setText('lAgain', t.again);
    setText('lOver', t.over);
    setText('lScore', t.score);

    setText('tAssets', t.tAssets);
    setText('hAssets', t.assetsHelp);
    setText('lHero', lang === 'ru' ? '–ü–µ—Ä—Å–æ–Ω–∞–∂' : 'Hero');
    setText('lGround', lang === 'ru' ? '–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è (–∑–µ–º–ª—è)' : 'Ground obstacles');
    setText('lGood', lang === 'ru' ? '–ü–æ–ª–µ–∑–Ω—ã–µ (–ª–µ—Ç—è—Ç)' : 'Good (air)');
    setText('lBad', lang === 'ru' ? '–û–ø–∞—Å–Ω—ã–µ (–ª–µ—Ç—è—Ç)' : 'Bad (air)');

    setText('tAudio', t.tAudio);
    setText('hAudio', t.audioHelp);

    setText('tQuestions', t.tQ);
    setHTML('hQuestions', t.qHelp.replaceAll('|','<b>|</b>'));
    setText('lQ', t.q);
    setText('lC', t.c);
    setText('lW', t.w);

    setText('btnPreview', t.btnPrev);
    setText('btnPublish', t.btnPub);
    setText('btnGet', t.btnGet);
    setText('statusPill', t.stReady);
  }

  // ===== helpers =====
  function parseList(val){
    return String(val).split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
  }
  function parseLines(val){
    return String(val).split('\n').map(s=>s.replace(/\r/g,''));
  }
  function makeIdFromTitle(cfg){
    const raw = (cfg.ui?.title || 'sheep-run').toLowerCase();
    const slug = raw
      .replace(/[^a-z0-9–∞-—è—ë\s_-]/gi,'')
      .trim()
      .replace(/[\s]+/g,'-')
      .replace(/-+/g,'-')
      .slice(0,40) || 'sheep-run';
    const d = new Date();
    const pad = (n)=>String(n).padStart(2,'0');
    const stamp = `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
    return `${slug}-${stamp}`;
  }

  function collectConfig(){
    const lang = $('uiLang').value;
    const mode = $('gameMode').value;
    const math = $('mathMode').checked;
    const transparentBg = $('transparentBg').checked;
    const mirrorHero = $('mirrorHero').checked;
    const randomQuestions = $('randomQuestions').checked;

    const ui = {
      title: $('ui_title').value || 'SHEEP RUN',
      start: $('ui_start').value || (lang === 'ru' ? '–ò–ì–†–ê–¢–¨' : 'PLAY'),
      again: $('ui_again').value || (lang === 'ru' ? '–ï–©–Å –†–ê–ó' : 'AGAIN'),
      gameover: $('ui_over').value || (lang === 'ru' ? '–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê' : 'GAME OVER'),
      scoreLabel: $('ui_score').value || (lang === 'ru' ? '–°—á—ë—Ç: ' : 'Score: '),
      fontSize: parseFloat(($('fontSize')?.value || '8'))
    };

    const winQuestions = parseInt(($('winQuestions').value || '10'), 10);
    const gameplay = { winQuestions: Number.isFinite(winQuestions) ? winQuestions : 10 };

    const assets = {
      hero: $('hero').value || 'üêë',
      mirrorHero,
      obstacles: {
        ground: parseList($('obs_ground').value),
        good:   parseList($('obs_good').value),
        bad:    parseList($('obs_bad').value)
      }
    };

    const sounds = {
      mus: $('aud_mus').value || '',
      ding: $('aud_ding').value || '',
      buzz: $('aud_buzz').value || '',
      coin: $('aud_coin').value || '',
      crash: $('aud_crash').value || '',
      win: $('aud_win').value || ''
    };

    // tasks (3 columns)
    const qLines = parseLines($('q_col').value);
    const cLines = parseLines($('c_col').value);
    const wLines = parseLines($('w_col').value);

    const tasks = [];
    const n = Math.max(qLines.length, cLines.length, wLines.length);
    for(let i=0;i<n;i++){
      const question = (qLines[i]||'').trim();
      const c = (cLines[i]||'').trim();
      const w = (wLines[i]||'').trim();
      if(!question && !c && !w) continue;

      const correct = (c ? c.split('|') : ['OK']).map(s=>s.trim()).filter(Boolean);
      const wrong = (w ? w.split('|') : ['NO']).map(s=>s.trim()).filter(Boolean);

      tasks.push({ question: question || '...', correct, wrong });
    }

    return { lang, mode, math, transparentBg, randomQuestions, ui, gameplay, assets, sounds, tasks };
  }

  function validate(cfg){
    if(!cfg.tasks.length) return (cfg.lang === 'ru') ? '–î–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã 1 –∑–∞–¥–∞–Ω–∏–µ.' : 'Add at least 1 task.';
    if(cfg.mode === 'input'){
      // must have correct answers
      const bad = cfg.tasks.find(t => !t.correct || !t.correct.length || !t.correct[0]);
      if(bad) return (cfg.lang === 'ru') ? '–í —Ä–µ–∂–∏–º–µ ‚Äú–í–ø–∏—à–∏ –æ—Ç–≤–µ—Ç‚Äù –≤ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω —Å—Ç–æ–ª–±–µ—Ü ‚Äú–í–µ—Ä–Ω–æ‚Äù.' : 'In input mode, every row must have ‚ÄúCorrect‚Äù.';
    }
    return '';
  }

  // ===== emoji quick insert =====
  let lastFocusedEl = null;
  document.addEventListener('focusin', (e)=>{
    const el = e.target;
    if(el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA')) lastFocusedEl = el;
  });
  function insertAtCursor(text){
    const el = lastFocusedEl;
    if(!el) return;
    const start = el.selectionStart ?? el.value.length;
    const end = el.selectionEnd ?? el.value.length;
    el.value = el.value.slice(0,start) + text + el.value.slice(end);
    el.focus();
    el.selectionStart = el.selectionEnd = start + text.length;
    queuePreview();
  }
  const HERO_EMO = ["üêë","üêê","ü¶ô","üêï","üêà","ü¶ä","üêâ","ü§ñ","üßô‚Äç‚ôÄÔ∏è","üßô‚Äç‚ôÇÔ∏è"];
  function mountEmojiBar(){
    const bar = $('heroEmojiBar');
    bar.innerHTML = '';
    HERO_EMO.forEach(e=>{
      const b = document.createElement('button');
      b.className='emojiBtn';
      b.type='button';
      b.textContent=e;
      b.onclick=()=>{ $('hero').focus(); insertAtCursor(e); };
      bar.appendChild(b);
    });
  }

  // ===== preview =====
  let previewTimer = null;
  function queuePreview(){
    if(previewTimer) clearTimeout(previewTimer);
    previewTimer = setTimeout(refreshPreview, 180);
  }

  function refreshPreview(){
    const cfg = collectConfig();
    const err = validate(cfg);
    if(err){
      setText('statusPill', I18N[cfg.lang]?.stErr || '–û—à–∏–±–∫–∞');
      return;
    }
    // preview: send config to the game via postMessage (works even if editor is opened as a local file)
    const pr = $('preview');
    pr.dataset.pendingCfg = JSON.stringify(cfg);
    pr.src = BASE_MAIN + "?preview=1&v=" + Date.now();
    setText('statusPill', (I18N[cfg.lang]?.stReady || '–ì–æ—Ç–æ–≤–æ'));
  }

  // ===== publish + get iframe =====
  let lastIframe = "";

  async function publish(){
    const cfg = collectConfig();
    const err = validate(cfg);
    if(err){ alert(err); setText('statusPill', I18N[cfg.lang]?.stErr || '–û—à–∏–±–∫–∞'); return; }

    setText('statusPill', I18N[cfg.lang]?.stPub || '–°–æ–∑–¥–∞—é‚Ä¶');

    const id = makeIdFromTitle(cfg);
    const payload = {
      id,
      mode: "json",
      folder: "texts/data",
      content: JSON.stringify(cfg, null, 2)
    };

    try{
      const res = await fetch(ENDPOINT, {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "X-Publish-Key": PUBLISH_KEY
        },
        body: JSON.stringify(payload)
      });

      if(!res.ok){
        const t = await res.text().catch(()=>res.statusText);
        throw new Error(t || "Server error");
      }

      lastIframe =
`<iframe
  src="${BASE_MAIN}?id=${encodeURIComponent(id)}"
  width="100%"
  height="650"
  style="border:0;display:block;background:transparent;"
  allow="autoplay; fullscreen"
  sandbox="allow-scripts allow-same-origin allow-forms"
></iframe>`;

      setText('statusPill', I18N[cfg.lang]?.stWait || '–ì–æ—Ç–æ–≤–æ ‚úÖ');
      toast(cfg.lang === 'ru' ? '–ò–≥—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞ ‚úÖ' : 'Game generated ‚úÖ');
    }catch(e){
      setText('statusPill', I18N[cfg.lang]?.stErr || '–û—à–∏–±–∫–∞');
      alert((cfg.lang === 'ru' ? '–°–µ—Ç—å/—Å–µ—Ä–≤–µ—Ä: ' : 'Network/server: ') + e.message);
    }
  }

  async function copyIframe(){
    const lang = $('uiLang').value;
    if(!lastIframe){
      toast(lang === 'ru' ? '–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∏–≥—Ä—É' : 'Generate the game first');
      return;
    }
    try{
      await navigator.clipboard.writeText(lastIframe);
      toast(lang === 'ru' ? '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!' : 'Copied!');
    }catch(e){
      // fallback
      const ta = document.createElement('textarea');
      ta.value = lastIframe;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      toast(lang === 'ru' ? '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!' : 'Copied!');
    }
  }

  // ===== init =====
  mountEmojiBar();
  try{ applyLang($('uiLang') ? $('uiLang').value : 'ru'); }catch(e){ console.error(e); }
  setText('fontSizeVal', $('fontSize').value);

  // When preview iframe loads, push latest config into the game
  $('preview').addEventListener('load', ()=>{
    try{
      const raw = $('preview').dataset.pendingCfg;
      if(!raw) return;
      const cfg = JSON.parse(raw);
      $('preview').contentWindow.postMessage({ type:'SHEEP_CFG', cfg }, '*');
    }catch(e){}
  });

  refreshPreview();

  $('btnPreview').addEventListener('click', refreshPreview);

  // font size label
  $('fontSize').addEventListener('input', ()=>{ setText('fontSizeVal', $('fontSize').value); });
  $('btnPublish').addEventListener('click', publish);
  $('btnGet').addEventListener('click', copyIframe);

  document.addEventListener('input', (e)=>{
    if(e.target && e.target.closest('.wrap')) queuePreview();
  });

  $('uiLang').addEventListener('change', ()=>{
    const prev = window.__lastLang || $('uiLang').value;
    const lang = $('uiLang').value;
    applyLang(lang);

    const DEF = {
      ru:{start:'–ò–ì–†–ê–¢–¨', again:'–ï–©–Å –†–ê–ó', over:'–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê', score:'–°—á—ë—Ç: '},
      en:{start:'PLAY', again:'AGAIN', over:'GAME OVER', score:'Score: '},
      fr:{start:'JOUER', again:'REJOUER', over:'FIN DE PARTIE', score:'Score : '},
      de:{start:'START', again:'NOCHMAL', over:'GAME OVER', score:'Punkte: '},
      es:{start:'JUGAR', again:'OTRA VEZ', over:'FIN DEL JUEGO', score:'Puntos: '},
      it:{start:'GIOCA', again:'DI NUOVO', over:'GAME OVER', score:'Punteggio: '},
      zh:{start:'ÂºÄÂßã', again:'ÂÜçÊù•‰∏ÄÊ¨°', over:'Ê∏∏ÊàèÁªìÊùü', score:'ÂæóÂàÜÔºö'},
      ja:{start:'„Çπ„Çø„Éº„Éà', again:'„ÇÇ„ÅÜ‰∏ÄÂõû', over:'„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº', score:'„Çπ„Ç≥„Ç¢Ôºö'}
    };

    const prevDef = DEF[prev] || DEF.en;
    const nextDef = DEF[lang] || DEF.en;

    const maybeReplace = (id, fromVal, toVal)=>{
      const el=$(id);
      if(!el) return;
      const v=(el.value||'').trim();
      if(v === fromVal) el.value = toVal;
    };

    maybeReplace('ui_start', prevDef.start, nextDef.start);
    maybeReplace('ui_again', prevDef.again, nextDef.again);
    maybeReplace('ui_over', prevDef.over, nextDef.over);
    // score label: replace if equals prev default or english default variants
    maybeReplace('ui_score', prevDef.score, nextDef.score);

    window.__lastLang = lang;
    queuePreview();
  });

  // --- language selectors ---
  document.getElementById('uiLangUI').addEventListener('change', ()=>{
    applyLang(document.getElementById('uiLangUI').value);
  });

  // game language affects default UI texts (only if user didn't customize)
  document.getElementById('uiLangGame').addEventListener('change', ()=>{
    const lang = document.getElementById('uiLangGame').value;

    const DEFAULTS = {
      ru: {start:'–ò–ì–†–ê–¢–¨', again:'–ï–©–Å –†–ê–ó', over:'–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê', score:'–°—á—ë—Ç: '},
      en: {start:'PLAY', again:'AGAIN', over:'GAME OVER', score:'Score: '},
      fr: {start:'JOUER', again:'REJOUER', over:'FIN DE PARTIE', score:'Score : '},
      de: {start:'SPIELEN', again:'NOCHMAL', over:'GAME OVER', score:'Punkte: '},
      es: {start:'JUGAR', again:'OTRA VEZ', over:'FIN DEL JUEGO', score:'Puntuaci√≥n: '},
      it: {start:'GIOCA', again:'DI NUOVO', over:'FINE', score:'Punteggio: '},
      zh: {start:'ÂºÄÂßã', again:'ÂÜçÊù•‰∏ÄÊ¨°', over:'Ê∏∏ÊàèÁªìÊùü', score:'ÂæóÂàÜÔºö'},
      ja: {start:'„Çπ„Çø„Éº„Éà', again:'„ÇÇ„ÅÜ‰∏ÄÂõû', over:'„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº', score:'„Çπ„Ç≥„Ç¢: '}
    };

    const allDefaults = Object.values(DEFAULTS).flatMap(d=>[d.start,d.again,d.over,d.score]);
    const fStart = document.getElementById('ui_start');
    const fAgain = document.getElementById('ui_again');
    const fOver  = document.getElementById('ui_over');
    const fScore = document.getElementById('ui_score');

    const cur = {start:fStart.value.trim(), again:fAgain.value.trim(), over:fOver.value.trim(), score:fScore.value};
    const should = DEFAULTS[lang] || DEFAULTS.en;

    if(!cur.start || allDefaults.includes(cur.start)) fStart.value = should.start;
    if(!cur.again || allDefaults.includes(cur.again)) fAgain.value = should.again;
    if(!cur.over  || allDefaults.includes(cur.over))  fOver.value  = should.over;
    if(!cur.score || allDefaults.includes(cur.score)) fScore.value = should.score;

    generate();
  });


  // ---------- tabs ----------
  function setTab(key){
    document.querySelectorAll('.tabBtn').forEach(b=>{
      const on = b.dataset.tab === key;
      b.classList.toggle('active', on);
      b.setAttribute('aria-selected', on ? 'true' : 'false');
    });
    document.querySelectorAll('.tabSection').forEach(s=>{
      s.classList.toggle('active', s.dataset.tab === key);
    });
  }
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.tabBtn');
    if(!btn) return;
    setTab(btn.dataset.tab);
  });


</script>
<script>
  // live preview on input
  document.addEventListener('input', (e)=>{
    const t = e.target;
    if(!t) return;
    const ids = new Set(['uiLang','gameMode','mathMode','transparentBg','mirrorHero','randomQuestions','winQuestions','fontSize',
      'ui_title','ui_start','ui_again','ui_over','ui_score','hero','obs_ground','obs_good','obs_bad',
      'aud_mus','aud_ding','aud_buzz','aud_coin','aud_crash','aud_win','q_col','c_col','w_col']);
    if(t.id && ids.has(t.id)) {
      if(typeof queuePreview === 'function') queuePreview();
    }
  });

  document.getElementById('uiLang').addEventListener('change', ()=>{
    if(typeof applyLang === 'function') applyLang(document.getElementById('uiLang').value);
    if(typeof queuePreview === 'function') queuePreview();
  });

  // init
  if(typeof mountEmojiBar === 'function') mountEmojiBar();
  if(typeof applyLang === 'function') applyLang(document.getElementById('uiLang').value);
  if(typeof refreshPreview === 'function') refreshPreview();
</script>
</body>
</html>
